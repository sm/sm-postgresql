#!/usr/bin/env bash

#
# pgha - PostgreSQL High Availability Monitor
#
# NOTES:
# - ${PGDATA}/pgha/master file with master IP address 
#   must be put in place by the provisioner
# - This script runs under the postgresql user as a minutely cronjob:
#
#    * * * * * PGDATA=/var/db/postgresql/9.3/data /opt/sm/bin/sm pgha run
#
# - To run manually in debug mode as user postgres:
# 
#   DEBUG=1 PGDATA=/var/db/postgresql/9.3/data sm pgha run
#
# TODO: 
# - vmotion master comes back online safely.
# - multiple failures including both master and sync.
#
# Questions:
#  - Should we save the original MasterIP when sync is promoted?  Not unless we want to report back 
#    to some central authority that the server pool lost a server
#
# Keep track of where we go next.
#

(( ${DEBUG:=0} == 0 )) || set -x

exec &> ${pghaLog}
echo "${timestamp}"

#If the server from the last run is still in the process of replicating, abort this process
if replicationIsStarting
then exit 0
fi

if isResponsive ${masterIP}
then loadIPs
fi

setMyRole

case ${myRole} in
  (master)
    saveIPs
    ;;
  (sync)
    if ! isResponsive ${masterIP}
    then promoteToMaster
    fi
    saveIPs
    ;;
  (replica)
    if isResponsive ${masterIP}
    then 
      saveIPs
    elif [[ -n ${syncIP} ]] && isResponsive ${syncIP}
    then 
      masterIP=${syncIP}
      if replicateFromMaster
      then
        loadIPs
        saveIPs
      fi
    else # master and sync replica are offline...
      if (( ${#replicaIPs} == 1 ))
      then # I am a replica and no other replicas exist.
        promoteToMaster
      elif  (( ${#replicaIPs} > 1 ))
      then
        firstReplica=${replicaIPs[1]}
        if isResponsive ${firstReplica}
        then
          masterIP=${firstReplica}
          if replicateFromMaster
          then
            loadIPs
            saveIPs
          fi
        fi
      fi
    fi
    ;;
  (new)
    if isResponsive ${masterIP}
    then
      if replicateFromMaster
      then
        loadIPs
        saveIPs
      fi
    elif [[ -n "${syncIP}" ]] && isResponsive ${syncIP}
    then
      masterIP=${syncIP}
      if replicateFromMaster
      then
        loadIPs
        saveIPs
      fi
    fi
    ;;
esac

exit $? # Let cron kickoff in one minute instead of sleeping
