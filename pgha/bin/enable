#!/bin/sh

typeset masterIp PGDATA masterFile debug entry
debug=0

if [[ $USER != 'postgres' ]]
then log fail "This must be run as the postgres user."
fi

while (( $# ))
do
    token=$1;shift
    case ${token} in
        (master)
            masterIp=$1 ; shift
            ;;
        (pgdata)
            PGDATA=${1} ; shift
            ;;
        (debug)
            debug=1
            ;;
        (*)
            log fail "Unhandled token '${token}'"
            ;;
    esac
done

if [[ -z ${masterIp} ]]
then log fail "'master <ip>' must be given"
fi

if [[ -z ${PGDATA} ]]
then log fail "'pgdata <PGDATA>' must be given"
fi

mkdir -p ${PGDATA}/pgha

masterFile=${PGDATA}/pgha/master
echo ${masterIP} > ${masterFile}
chown -R postgres:postgres ${PGDATA}/pgha

if (( debug == 0 ))
then entry="* * * * * PGDATA=${PGDATA} /opt/sm/bin/sm pgha run"
else entry="* * * * * DEBUG=1 PGDATA=${PGDATA} /opt/sm/bin/sm pgha run"
fi

if crontab -u postgres -l | grep -q -v pgha 
then (crontab -u postgres -l ; echo ${entry}) | crontab -u postgres -
fi

