#!/bin/sh

typeset -x masterIp PGDATA masterFile debug entry pghaPath
debug=0

if [[ -z ${masterIp} ]]
then log fail "'master <ip>' must be given"
fi

if [[ -z ${PGDATA} ]]
then log fail "'pgdata <PGDATA>' must be given"
fi

pghaPath=${PGDATA}/../pgha # Parallel to PGDATA
masterFile=${pghaPath}/master

mkdir -p ${pghaPath}
echo ${masterIp} > ${masterFile}
chown -R postgres:postgres ${pghaPath}

if (( debug == 0 ))
then entry="* * * * * PGDATA=${PGDATA} /opt/sm/bin/sm pgha run"
else entry="* * * * * DEBUG=1 PGDATA=${PGDATA} /opt/sm/bin/sm pgha run"
fi

if ! crontab -l | grep -q pgha
then (crontab -l ; echo ${entry}) | crontab -
fi

